name: Kaniko smoke test
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: k3s-runners

    # Use a glibc-based job container so JS actions can run (/__e/node20/bin/node).
    container:
      image: ubuntu:24.04

    steps:
      - uses: actions/checkout@v4

      - name: Build and push with Kaniko
        env:
          IMAGE: registry.isaacdelalama.dev/test/kaniko-smoke:${{ github.sha }}
        run: |
          apt-get update
          apt-get install -y --no-install-recommends ca-certificates curl
          rm -rf /var/lib/apt/lists/*

          curl -fsSL \
            -o /usr/local/bin/kaniko-executor \
            https://github.com/GoogleContainerTools/kaniko/releases/download/v1.24.0/executor_linux_amd64
          chmod +x /usr/local/bin/kaniko-executor

          # Kaniko expects docker auth at /kaniko/.docker/config.json
          mkdir -p /kaniko/.docker
          cp /run/secrets/registry-config/config.json /kaniko/.docker/config.json

          /usr/local/bin/kaniko-executor \
            --context "${GITHUB_WORKSPACE}" \
            --dockerfile "${GITHUB_WORKSPACE}/Dockerfile" \
            --destination "${IMAGE}"
