name: Kaniko smoke test
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: k3s-runners

    # ARC kube-mode uses `tail` for container jobs; debug image includes it.
    container:
      image: gcr.io/kaniko-project/executor:v1.24.0-debug

    steps:
      - name: Build and push with Kaniko
        env:
          IMAGE: registry.isaacdelalama.dev/test/kaniko-smoke:${{ github.sha }}
        run: |
          WORKDIR=/workspace/src
          ARCHIVE=/workspace/src.tar.gz
          mkdir -p "${WORKDIR}"

          # Avoid JS actions in kaniko container by fetching source archive directly.
          wget -q -O "${ARCHIVE}" "https://codeload.github.com/${GITHUB_REPOSITORY}/tar.gz/${GITHUB_SHA}"
          tar -xzf "${ARCHIVE}" -C "${WORKDIR}" --strip-components=1

          # Kaniko expects docker auth at /kaniko/.docker/config.json
          mkdir -p /kaniko/.docker
          cp /run/secrets/registry-config/config.json /kaniko/.docker/config.json

          /kaniko/executor \
            --context "${WORKDIR}" \
            --dockerfile "${WORKDIR}/Dockerfile" \
            --destination "${IMAGE}"
