name: Kaniko smoke test
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: k3s-runners

    # ARC kube-mode uses `tail` for container jobs; debug image includes it.
    container:
      image: gcr.io/kaniko-project/executor:v1.24.0-debug

    steps:
      - name: Build and push with Kaniko
        env:
          IMAGE: registry.isaacdelalama.dev/test/kaniko-smoke:${{ github.sha }}
          REGISTRY_USERNAME: ${{ secrets.REGISTRY_USERNAME }}
          REGISTRY_PASSWORD: ${{ secrets.REGISTRY_PASSWORD }}
        run: |
          WORKDIR=/workspace/src
          ARCHIVE=/workspace/src.tar.gz
          mkdir -p "${WORKDIR}"

          # Avoid JS actions in kaniko container by fetching source archive directly.
          wget -q -O "${ARCHIVE}" "https://codeload.github.com/${GITHUB_REPOSITORY}/tar.gz/${GITHUB_SHA}"
          tar -xzf "${ARCHIVE}" -C "${WORKDIR}" --strip-components=1

          # Kaniko expects docker auth at /kaniko/.docker/config.json
          # Build it from GitHub Actions secrets instead of a missing k8s mount.
          : "${REGISTRY_USERNAME:?REGISTRY_USERNAME secret is required}"
          : "${REGISTRY_PASSWORD:?REGISTRY_PASSWORD secret is required}"
          mkdir -p /kaniko/.docker
          cat > /kaniko/.docker/config.json <<EOF
          {"auths":{"registry.isaacdelalama.dev":{"username":"${REGISTRY_USERNAME}","password":"${REGISTRY_PASSWORD}"}}}
          EOF

          /kaniko/executor \
            --context "${WORKDIR}" \
            --dockerfile "${WORKDIR}/Dockerfile" \
            --destination "${IMAGE}"
